"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.migrateHelmImportsGenerator = migrateHelmImportsGenerator;
const tslib_1 = require("tslib");
const devkit_1 = require("@nx/devkit");
const devkit_exports_1 = require("nx/src/devkit-exports");
const path_1 = require("path");
const binary_extensions_1 = require("../migrate-brain-imports/utils/binary-extensions");
const import_map_1 = tslib_1.__importDefault(require("./import-map"));
async function migrateHelmImportsGenerator(tree, options) {
    for (const [from, to] of Object.entries(import_map_1.default)) {
        replaceUsages(tree, from, to);
    }
    if (!options.skipFormat) {
        await (0, devkit_1.formatFiles)(tree);
    }
}
// based on https://github.com/nrwl/nx/blob/master/packages/devkit/src/utils/replace-package.ts
function replaceUsages(tree, oldPackageName, newPackageName) {
    (0, devkit_1.visitNotIgnoredFiles)(tree, '.', (path) => {
        if ((0, binary_extensions_1.isBinaryPath)(path)) {
            return;
        }
        const ignoredFiles = [
            'yarn.lock',
            'package-lock.json',
            'pnpm-lock.yaml',
            'bun.lockb',
            'CHANGELOG.md',
            // this is relevant for this repo only - and this file is auto-generated
            'supported-ui-libraries.json',
            // we don't want to replace usages in the import map as these are used to detect the usages
            'import-map.ts',
        ];
        if (ignoredFiles.includes((0, path_1.basename)(path))) {
            return;
        }
        try {
            const contents = tree.read(path).toString();
            if (!contents.includes(oldPackageName)) {
                return;
            }
            tree.write(path, contents.replace(new RegExp(oldPackageName, 'g'), newPackageName));
        }
        catch {
            devkit_exports_1.logger.warn(`Could not replace ${oldPackageName} with ${newPackageName} in ${path}.`);
        }
    });
}
exports.default = migrateHelmImportsGenerator;
//# sourceMappingURL=generator.js.map